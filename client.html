<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>كشف حساب العميل</title>

<style>
body {font-family:"Tajawal",sans-serif;background:#F2F4F7;margin:0;padding-bottom:60px;}
*{box-sizing:border-box;}
h2,h3,h4,h5{margin:0;padding:0;}
.header{background:linear-gradient(135deg,#000,#1a1a1a,#2a2a2a);padding:40px 20px 60px;color:white;border-bottom-left-radius:30px;border-bottom-right-radius:30px;text-align:center;}
.client-info img{width:75px;height:75px;border-radius:50%;border:3px solid #fff;object-fit:cover;}
.client-info h2{margin-top:12px;font-size:clamp(18px,2.5vw,22px);font-weight:600;color:#f1f1f1;}
.balance-card{width:92%;max-width:450px;background:white;padding:15px 20px;border-radius:15px;box-shadow:0 6px 20px rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:space-between;margin:-40px auto 20px auto;position:relative;}
.balance-label{font-size:clamp(15px,2vw,18px);font-weight:bold;color:#444;}
.balance-value{font-size:clamp(18px,2.8vw,22px);font-weight:bold;}
#refreshBtn{background:#333;border:none;padding:8px 12px;border-radius:50%;color:white;cursor:pointer;font-size:15px;margin-right:10px;transition:.2s;}
#refreshBtn:hover{background:#444;transform:scale(1.1);}
.container{padding:20px;}
.last-ops-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.last-ops h3{color:#003575;font-size:clamp(16px,2vw,20px);}
.op-card{background:#fff;padding:10px 15px;border-radius:12px;margin-bottom:10px;display:flex;justify-content:space-between;box-shadow:0 3px 12px rgba(0,0,0,0.08);font-size:clamp(13px,1.8vw,15px);}
.op-card .op-note{color:#6b7280;font-size:clamp(12px,1.6vw,14px);}
.credit{color:#0FA958;font-weight:bold;}
.debit{color:#D13A3A;font-weight:bold;}
.btn{width:100%;padding:15px;font-size:clamp(16px,2vw,18px);border-radius:12px;margin-top:10px;margin-bottom:10px;cursor:pointer;font-weight:600;border:none;}
#showStatementBtn{background:linear-gradient(135deg,#111,#1a1a1a,#222);color:white;padding:10px 18px;border-radius:12px;cursor:pointer;width:100%;font-weight:bold;font-size:clamp(14px,2vw,16px);transition:.3s;box-shadow:0 4px 12px rgba(0,0,0,0.35);}
#showStatementBtn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,0.45);background:linear-gradient(135deg,#1a1a1a,#222,#2a2a2a);}
table{width:100%;border-collapse:collapse;margin-top:15px;background:white;border-radius:12px;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,0.1);font-size:clamp(14px,2vw,16px);}
th{background:#F1F5F9;padding:14px;color:#003575;font-weight:700;}
td{padding:12px;text-align:center;border-bottom:1px solid #e5e7eb;}
.op-amount{font-weight:bold;font-size:clamp(14px,2vw,16px);padding:4px 8px;border-radius:8px;}
.op-amount.credit{color:#0FA958;background:#E6F6EC;}
.op-amount.debit{color:#D13A3A;background:#FDEAEA;}

.logout-btn{position:absolute;top:10px;left:10px;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(0,0,0,0.2);cursor:pointer;transition:.3s;}
.logout-btn:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(0,0,0,0.3);}

#statementModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:1000;overflow-y:auto;}
#statementContent{background:white;width:95%;max-width:900px;margin:40px auto;border-radius:12px;padding:20px;position:relative;box-shadow:0 6px 25px rgba(0,0,0,0.3);}
#statementContent h3{text-align:center;margin-bottom:15px;color:#000000;}
#printClientName {text-align:center; font-weight:bold; margin-bottom: 15px;}
#closeStatement{position:absolute;top:15px;right:15px;background:linear-gradient(135deg,#333,#444,#555);color:#f1f1f1;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;font-weight:bold;}
.filter-dates{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin-bottom:15px;}
.filter-dates label input{padding:5px 8px;border-radius:6px;border:1px solid #ccc;}

#totalsBox{background:#fff;padding:10px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1);margin:10px 0;text-align:center;font-size:15px;}

.footer{text-align:center;padding:15px 10px;background:linear-gradient(135deg,#111,#1a1a1a,#222);color:#f1f1f1;font-size:clamp(13px,1.5vw,14px);position:fixed;bottom:0;width:100%;z-index:1000;}

#toTop{position:fixed;bottom:80px;right:20px;width:45px;height:45px;background:#222;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;display:none;box-shadow:0 5px 15px rgba(0,0,0,0.3);}
#toTop:hover{background:#000;}
#modalBalanceValue {
    display: block;
    text-align: center;
    font-size: 22px;
    margin-bottom: 15px;
}
</style>
</head>

<body>

<div class="header">
    <div class="client-info">
        <img src="https://raw.githubusercontent.com/falahsab/jedwal/refs/heads/main/img/jedwal11.png">
        <h2 id="clientName"></h2>
    </div>
</div>

<div class="balance-card">
    <span class="balance-label" id="balanceText"></span>
    <span class="balance-value" id="balanceValue"></span>
    <button id="refreshBtn">↻</button>
</div>

<div class="logout-btn" id="logoutBtn">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white"><path d="M16 13v-2H7V8l-5 4 5 4v-3h9zm3-11H5c-1.1 0-2 .9-2 2v6h2V4h14v16H5v-6H3v6c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
</div>

<div class="container">
    <div class="last-ops-header">
        <h3>آخر 5 عمليات</h3>
    </div>
    <div class="last-ops">
        <div id="lastOpsList"></div>
    </div>
   <button id="showStatementBtn" style="display:none;">عرض كل الحساب</button>
</div>

<div id="statementModal">
    <div id="statementContent">
        <button id="closeStatement">رجوع</button>
        <h3>كشف الحساب</h3>
        <p id="printClientName"></p>
        <span class="balance-value" id="modalBalanceValue"></span>

        <div class="filter-dates">
            <label>من: <input type="date" id="fromDate"></label>
            <label>إلى: <input type="date" id="toDate"></label>
        </div>

        <div id="totalsBox"></div>

        <button id="printStatement" class="btn" style="background:#222;color:white;">طباعة PDF</button>
        <button id="exportExcel" class="btn" style="background:#444;color:white;">تصدير Excel</button>

        <div id="statementList"></div>
    </div>
</div>

<div id="toTop">↑</div>

<footer class="footer">
     <strong>يمن ستلايت</strong> | 738092209
</footer>

<script>
const API="https://script.google.com/macros/s/AKfycbyTBztcQHgbaYmtle4dPg0ZWIchR48lnhBZz5Z1fM1qb0RNqYMJSd-ptRcx8u58gaPF/exec";

if(!localStorage.getItem("client_id")){
    alert("يرجى تسجيل الدخول أولاً");
    window.location="index.html";
}

document.getElementById("clientName").innerText=localStorage.getItem("client_name");

loadTotal();

async function loadTotal(){
    let res=await fetch(API,{
        method:"POST",
        body:JSON.stringify({
            action:"getClientData",
            client_id:localStorage.getItem("client_id")
        })
    });
    let data=await res.json();
    let total=Number(data.total);

    const balanceText=document.getElementById("balanceText");
    const balanceValue=document.getElementById("balanceValue");
    const modalBalanceValue=document.getElementById("modalBalanceValue");

    if(total < 0){
        balanceText.innerText="لكم:";
        balanceValue.innerText=Math.abs(total)+" ريال";
        modalBalanceValue.innerText = "لكم: " + Math.abs(total) + " ريال";
        balanceValue.style.color="#0FA958";
        modalBalanceValue.style.color="#0FA958";
    } else {
        balanceText.innerText="عليكم:";
        balanceValue.innerText=total+" ريال";
        modalBalanceValue.innerText = "عليكم: " + total + " ريال";
        balanceValue.style.color="#D13A3A";
        modalBalanceValue.style.color="#D13A3A";
    }

    showLast5(data.list);
}

document.getElementById("refreshBtn").addEventListener("click",loadTotal);

function showLast5(list){
    let box=document.getElementById("lastOpsList");
    box.innerHTML="";
    list.sort((a,b)=>new Date(b.date)-new Date(a.date))
    .slice(0,5)
    .forEach(r=>{
        const typeClass = r.amount < 0 ? "credit" : "debit";
        box.innerHTML+=`
        <div class="op-card">
            <div class="op-details">
                <div class="op-date">${new Date(r.date).toLocaleDateString()}</div>
                <div class="op-note">${r.note}</div>
            </div>
            <div class="op-amount ${typeClass}">
                ${r.amount < 0 ? '+' : '-'}${Math.abs(r.amount)}
            </div>
        </div>`;
    });
    document.getElementById("showStatementBtn").style.display = "block";
}

/* OPEN STATEMENT */
document.getElementById("showStatementBtn").addEventListener("click",async()=>{
    document.getElementById("statementModal").style.display="block";

    let res=await fetch(API,{
        method:"POST",
        body:JSON.stringify({
            action:"getClientData",
            client_id:localStorage.getItem("client_id")
        })
    });

    let data=await res.json();
    const statementList=document.getElementById("statementList");

    // اسم العميل في المودال
    document.getElementById("printClientName").innerText = "اسم العميل: " + (localStorage.getItem("client_name") || "غير معروف");

    function calcTotals(list){
        let totalCredit = 0;
        let totalDebit = 0;
        list.forEach(r => {
            if (r.amount < 0) totalCredit += Math.abs(r.amount);
            else totalDebit += r.amount;
        });

        let net = totalDebit - totalCredit;
        let netText = "";
        let netColor = "";

        if (net < 0) {
            netText = "الصافي: لكم " + Math.abs(net) + " ريال";
            netColor = "#0FA958";
        } else if (net > 0) {
            netText = "الصافي: عليكم " + net + " ريال";
            netColor = "#D13A3A";
        } else {
            netText = "الصافي: لا يوجد (0 ريال)";
            netColor = "#333";
        }

        document.getElementById("totalsBox").innerHTML = `
            <div style="text-align:center;">
                <div>إجمالي لكم: <strong style="color:#0FA958">${totalCredit} ريال</strong></div>
                <div>إجمالي عليكم: <strong style="color:#D13A3A">${totalDebit} ريال</strong></div>
                <div style="
                    margin-top:12px;
                    font-size:18px;
                    font-weight:bold;
                    color:${netColor};
                    padding:8px 0;
                ">
                    ${netText}
                </div>
            </div>
        `;
    }

    function renderOperations(list){
        statementList.innerHTML="";
        list.forEach(r=>{
            const typeClass=r.amount < 0 ? "credit" : "debit";
            statementList.innerHTML+=`
            <div class="op-card">
                <div class="op-details">
                    <div class="op-date">${new Date(r.date).toLocaleDateString()}</div>
                    <div class="op-note">${r.note}</div>
                </div>
                <div class="op-amount ${typeClass}">
                    ${r.amount < 0 ? '+' : '-'}${Math.abs(r.amount)}
                </div>
            </div>`;
        });
    }

    const sorted=data.list.sort((a,b)=>new Date(b.date)-new Date(a.date));
    renderOperations(sorted);
    calcTotals(sorted);

    document.getElementById("fromDate").onchange=filterOps;
    document.getElementById("toDate").onchange=filterOps;

    function filterOps(){
        const from=document.getElementById("fromDate").value;
        const to=document.getElementById("toDate").value;

        const fromDate=from ? new Date(from+"T00:00:00") : null;
        const toDate=to ? new Date(to+"T23:59:59") : null;

        const filtered=data.list.filter(r=>{
            const d=new Date(r.date);
            if(fromDate && d<fromDate) return false;
            if(toDate && d>toDate) return false;
            return true;
        });

        filtered.sort((a,b)=>new Date(b.date)-new Date(a.date));
        renderOperations(filtered);
        calcTotals(filtered);
    }
});

/* PRINT */
document.getElementById("printStatement").addEventListener("click",()=>{
    window.print();
});

/* EXPORT EXCEL */
document.getElementById("exportExcel").addEventListener("click", () => {
    let clientName = document.getElementById("clientName").innerText || "اسم العميل غير معروف";

    let rows = [
        ["اسم العميل:", clientName],
        [],
        ["التاريخ", "البيان", "المبلغ"]
    ];

    document.querySelectorAll("#statementList .op-card").forEach(card => {
        let date = card.querySelector(".op-date").innerText;
        let note = card.querySelector(".op-note").innerText;
        let safeNote = `="${note.replace(/"/g, '""')}"`;
        let amount = `="${card.querySelector(".op-amount").innerText.replace(/'/g, "")}"`;

        rows.push([date, safeNote, amount]);
    });

    let csvContent = "\uFEFF" + rows.map(e => e.join(",")).join("\n");

    let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    let url = URL.createObjectURL(blob);

    let a = document.createElement("a");
    a.href = url;
    a.download = "كشف الحساب.csv";
    a.click();
});

/* CLOSE MODAL */
document.getElementById("closeStatement").addEventListener("click",()=>{
    document.getElementById("statementModal").style.display="none";
});

/* LOGOUT */
document.getElementById("logoutBtn").addEventListener("click",()=>{
    localStorage.removeItem("client_id");
    localStorage.removeItem("client_name");
    window.location="index.html";
});

/* TO TOP BUTTON */
const toTop=document.getElementById("toTop");
window.onscroll=()=>{
    if(window.scrollY>300) toTop.style.display="flex";
    else toTop.style.display="none";
};
toTop.onclick=()=>window.scrollTo({top:0,behavior:"smooth"});
</script>

</body>
</html>
